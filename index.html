<html>

<head>
	<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
	<meta charset="utf-8">
	<style>
		body {
			margin: 0px;
			background-color: black;
		}
	</style>
</head>

<body>
	<video id="player" controls loop width="100%" height="100%" src=""></video>
</body>

<script>
	let params = new URLSearchParams(document.location.search);

	let video = document.querySelector('#player');
	video.src = params.get("url");

	let video_code = btoa(video.src.substring(Math.max(video.src.length - 16, 0), video.src.length));

	video.addEventListener("canplaythrough", async function video_func() {
		let subtitles = params.get("subtitles");
		if (subtitles != null) {
			let track = document.createElement("track");
			track.srclang = params.get("subtitles_srclang");
			track.label = params.get("subtitles_label");
			track.kind = "subtitles";
			track.mode = "showing";
			track.default = true;

			let response = await fetch(subtitles);
			let data = await response.text();
			let vtt_blob = new Blob([data], {
				type: 'text/plain'
			});
			track.src = URL.createObjectURL(vtt_blob);

			video.appendChild(track);
			video.textTracks[0].mode = "showing";
		}

		let init_value = localStorage.getItem(video_code);
		if (init_value != "") {
			video.currentTime = init_value;
		} else {
			video.autoplay = true;
		}
		video.play();

		video.removeEventListener('canplaythrough', video_func);

		let lastSeconds = null;
		video.addEventListener("timeupdate", function () {
			let seconds = Math.floor(video.currentTime);
			if ((seconds % 5) == 0 && seconds != lastSeconds) {
				localStorage.setItem(video_code, seconds);
				lastSeconds = seconds;
			}
		});
	});
</script>

</html>